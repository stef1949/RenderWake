name: Build, Sign & Attach Extension ZIP to Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-sign-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version from tag
        id: vars
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"      
          VERSION="${TAG#v}"           
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify extension structure (debug)
        shell: bash
        run: |
          set -euxo pipefail
          echo "PWD: $(pwd)"
          echo "Repo root listing:"
          ls -la

          EXT_DIR="."
          echo "Checking extension dir: $EXT_DIR"
          ls -la "$EXT_DIR" || true

          echo "Tree (top 4 levels):"
          find . -maxdepth 4 -print

          test -d "$EXT_DIR"
          test -f "$EXT_DIR/blender_manifest.toml"
          test -f "$EXT_DIR/README.md"
          test -d "$EXT_DIR/addon"

          echo "Extension structure OK"

      - name: Create ZIP
        shell: bash
        run: |
          EXT_DIR="."
          VERSION="${{ steps.vars.outputs.version }}"
          ZIP_NAME="renderwake-${VERSION}.zip"

          zip -r "$ZIP_NAME" "$EXT_DIR" \
            -x "**/.DS_Store" "**/__pycache__/**" "**/*.pyc" \
            -x ".git/**" ".github/**" ".external/**" ".gitignore"

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          ls -lh "$ZIP_NAME"

      - name: Generate SHA256 checksum
        shell: bash
        run: |
          sha256sum "$ZIP_NAME" > "$ZIP_NAME.sha256"
          echo "SHA256_FILE=$ZIP_NAME.sha256" >> "$GITHUB_ENV"
          cat "$ZIP_NAME.sha256"

      - name: Import GPG key
        shell: bash
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          for fpr in $(gpg --batch --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10}'); do
            echo "$fpr:6:" | gpg --batch --import-ownertrust
          done

      - name: Sign ZIP (detached signature)
        shell: bash
        run: |
          SIG_FILE="$ZIP_NAME.asc"
          echo "SIG_FILE=$SIG_FILE" >> "$GITHUB_ENV"

          if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
            gpg --batch --yes --pinentry-mode loopback \
              --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
              --armor --detach-sign "$ZIP_NAME"
          else
            gpg --batch --yes --armor --detach-sign "$ZIP_NAME"
          fi

          ls -lh "$SIG_FILE"

      - name: Prepare public key asset name
        shell: bash
        run: |
          cp docs/signing-key.asc signing-key.asc

      - name: Create or update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.SHA256_FILE }}
            ${{ env.SIG_FILE }}
            signing-key.asc
          generate_release_notes: true

      - name: Append checksum/signature verification instructions to release notes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = context.ref.replace('refs/tags/', '');

            const zip = process.env.ZIP_NAME;
            const sha = process.env.SHA256_FILE;
            const asc = process.env.SIG_FILE;

            const rel = await github.rest.repos.getReleaseByTag({ owner, repo, tag });

            const marker = "## Verify downloads";
            const block = [
              marker,
              "",
              "Public signing key is attached as `signing-key.asc` and stored in the repo at `docs/signing-key.asc`.",
              "",
              "**SHA-256**",
              "```bash",
              `sha256sum -c ${sha}`,
              "```",
              "",
              "**GPG signature**",
              "```bash",
              "gpg --import signing-key.asc",
              `gpg --verify ${asc} ${zip}`,
              "```",
              ""
            ].join("\n");

            const body = rel.data.body || "";
            const newBody = body.includes(marker)
              ? body
              : `${body}\n\n${block}`.trim();

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: rel.data.id,
              body: newBody,
            });
